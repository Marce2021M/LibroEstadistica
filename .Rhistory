ygorro  <- n*mean(muestra)
f1      <- function(lambda){ppois(ygorro, n*lambda) - alfa/2}
lambda1 <- uniroot(f1, lower = 0, upper = 10)$root
f2      <- function(lambda){1 - ppois(ygorro, n*lambda) +
dpois(ygorro, n*lambda) - alfa/2}
lambda2 <- uniroot(f2, lower = 0, upper = 10)$root
ic <- c(lambda2, lambda1)
ic <- c(lambda1, lambda2)
ic
muestra <- rpois(100000, 0.000001)
alfa    <- 0.01 #confianza de  0.99
n       <- length(muestra)
ygorro  <- n*mean(muestra)
f1      <- function(lambda){ppois(ygorro, n*lambda) - alfa/2}
lambda1 <- uniroot(f1, lower = 0, upper = 10)$root
f2      <- function(lambda){1 - ppois(ygorro, n*lambda) +
dpois(ygorro, n*lambda) - alfa/2}
lambda2 <- uniroot(f2, lower = 0, upper = 10)$root
ic <- c(lambda2, lambda1)
ic <- c(lambda1, lambda2)
ic
rm(list = ls())
library(tidyverse)
library(haven)
setwd("/Users/rod/Dropbox/Coronavirus/walmart")
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta")
dats <- dats %>%
mutate(fh_inicio_itt = dmy(fh_inicio_itt)) %>%
mutate(semana_epidemiologica = epiweek(fh_inicio_itt)) %>%
mutate(mean_trabajadores = mean(tot_trab_03, tot_trab_04, tot_trab_05,
tot_trab_06, tot_trab_07, tot_trab_08. tot_trab_09,
tot_trab_10))
dats <- dats %>%
mutate(fh_inicio_itt = dmy(fh_inicio_itt)) %>%
mutate(semana_epidemiologica = epiweek(fh_inicio_itt)) %>%
mutate(mean_trabajadores = mean(tot_trab_03, tot_trab_04, tot_trab_05,
tot_trab_06, tot_trab_07, tot_trab_08, tot_trab_09,
tot_trab_10))
library(lubridate)
dats <- dats %>%
mutate(fh_inicio_itt = dmy(fh_inicio_itt)) %>%
mutate(semana_epidemiologica = epiweek(fh_inicio_itt)) %>%
mutate(mean_trabajadores = mean(tot_trab_03, tot_trab_04, tot_trab_05,
tot_trab_06, tot_trab_07, tot_trab_08, tot_trab_09,
tot_trab_10))
dats <- dats %>%
mutate(fh_inicio_itt = dmy(fh_inicio_itt)) %>%
mutate(semana_epidemiologica = epiweek(fh_inicio_itt)) %>%
mutate(mean_trabajadores = 1/8*(tot_trab_03 + tot_trab_04 + tot_trab_05 + tot_trab_06 +
tot_trab_07 + tot_trab_08 + tot_trab_09 + tot_trab_10))
mutate(trabajadores = case_when(
month(fh_inicio_itt) == 3 ~ tot_trab_03,
month(fh_inicio_itt) == 4 ~ tot_trab_04,
month(fh_inicio_itt) == 5 ~ tot_trab_05,
month(fh_inicio_itt) == 6 ~ tot_trab_06,
month(fh_inicio_itt) == 7 ~ tot_trab_07,
month(fh_inicio_itt) == 8 ~ tot_trab_08,
month(fh_inicio_itt) == 9 ~ tot_trab_09,
month(fh_inicio_itt) == 10 ~ tot_trab_10,
TRUE ~ mean_trabajadores
))
fh_inicio_itt
dats <- dats %>%
mutate(fh_inicio_itt = dmy(fh_inicio_itt)) %>%
mutate(semana_epidemiologica = epiweek(fh_inicio_itt)) %>%
mutate(mean_trabajadores = 1/8*(tot_trab_03 + tot_trab_04 + tot_trab_05 + tot_trab_06 +
tot_trab_07 + tot_trab_08 + tot_trab_09 + tot_trab_10)) %>%
mutate(trabajadores = case_when(
month(fh_inicio_itt) == 3 ~ tot_trab_03,
month(fh_inicio_itt) == 4 ~ tot_trab_04,
month(fh_inicio_itt) == 5 ~ tot_trab_05,
month(fh_inicio_itt) == 6 ~ tot_trab_06,
month(fh_inicio_itt) == 7 ~ tot_trab_07,
month(fh_inicio_itt) == 8 ~ tot_trab_08,
month(fh_inicio_itt) == 9 ~ tot_trab_09,
month(fh_inicio_itt) == 10 ~ tot_trab_10,
TRUE ~ mean_trabajadores
))
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta")
dats <- dats %>%
mutate(fh_inicio_itt = dmy(fh_inicio_itt)) %>%
mutate(semana_epidemiologica = epiweek(fh_inicio_itt)) %>%
mutate(mean_trabajadores = 1/8*(tot_trab_03 + tot_trab_04 + tot_trab_05 + tot_trab_06 +
tot_trab_07 + tot_trab_08 + tot_trab_09 + tot_trab_10)) %>%
mutate(trabajadores = case_when(
month(fh_inicio_itt) == 3 ~ tot_trab_03,
month(fh_inicio_itt) == 4 ~ tot_trab_04,
month(fh_inicio_itt) == 5 ~ tot_trab_05,
month(fh_inicio_itt) == 6 ~ tot_trab_06,
month(fh_inicio_itt) == 7 ~ tot_trab_07,
month(fh_inicio_itt) == 8 ~ tot_trab_08,
month(fh_inicio_itt) == 9 ~ tot_trab_09,
month(fh_inicio_itt) == 10 ~ tot_trab_10,
TRUE ~ mean_trabajadores
))
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta") %>%
mutate(fh_inicio_itt = dmy(fh_inicio_itt)) %>%
mutate(semana_epidemiologica = epiweek(fh_inicio_itt)) %>%
mutate(mean_trabajadores = 1/8*(tot_trab_03 + tot_trab_04 + tot_trab_05 + tot_trab_06 +
tot_trab_07 + tot_trab_08 + tot_trab_09 + tot_trab_10)) %>%
mutate(trabajadores = case_when(
month(fh_inicio_itt) == 3 ~ tot_trab_03,
month(fh_inicio_itt) == 4 ~ tot_trab_04,
month(fh_inicio_itt) == 5 ~ tot_trab_05,
month(fh_inicio_itt) == 6 ~ tot_trab_06,
month(fh_inicio_itt) == 7 ~ tot_trab_07,
month(fh_inicio_itt) == 8 ~ tot_trab_08,
month(fh_inicio_itt) == 9 ~ tot_trab_09,
month(fh_inicio_itt) == 10 ~ tot_trab_10,
TRUE ~ mean_trabajadores
)) %>%
group_by(cve_reg_patronal, semana_epidemiologica, trabajadores,
descripcion_division, delegacion_ads, nombre_empresa) %>%
tally()
dats <- dats %>%
mutate(probabilidad_empresa = n/trabajadores)
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta")
dats <- dats %>%
mutate(fh_inicio_itt = dmy(fh_inicio_itt)) %>%
mutate(semana_epidemiologica = epiweek(fh_inicio_itt)) %>%
mutate(mean_trabajadores = 1/8*(tot_trab_03 + tot_trab_04 + tot_trab_05 + tot_trab_06 +
tot_trab_07 + tot_trab_08 + tot_trab_09 + tot_trab_10)) %>%
mutate(trabajadores = case_when(
month(fh_inicio_itt) == 3 ~ tot_trab_03,
month(fh_inicio_itt) == 4 ~ tot_trab_04,
month(fh_inicio_itt) == 5 ~ tot_trab_05,
month(fh_inicio_itt) == 6 ~ tot_trab_06,
month(fh_inicio_itt) == 7 ~ tot_trab_07,
month(fh_inicio_itt) == 8 ~ tot_trab_08,
month(fh_inicio_itt) == 9 ~ tot_trab_09,
month(fh_inicio_itt) == 10 ~ tot_trab_10,
TRUE ~ mean_trabajadores
)) %>%
group_by(cve_reg_patronal, semana_epidemiologica, trabajadores,
descripcion_division, delegacion_ads, nombre_empresa) %>%
tally() %>%
mutate(probabilidad_empresa = n/trabajadores)
dats <- dats %>% ungroup()
rubro <- dats %>%
groupby(semana_epidemiologica, delegacion_ads, descripcion_division, n, trabajadores) %>%
summarise(n_total = sum(n), n_trabajadores = sum(trabajadores))
rubro <- dats %>%
group_by(semana_epidemiologica, delegacion_ads, descripcion_division, n, trabajadores) %>%
summarise(n_total = sum(n), n_trabajadores = sum(trabajadores))
rubro
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta")
dats <- dats %>%
filter(descripcion_div != "") %>%
mutate(fh_inicio_itt = dmy(fh_inicio_itt)) %>%
mutate(semana_epidemiologica = epiweek(fh_inicio_itt)) %>%
mutate(mean_trabajadores = 1/8*(tot_trab_03 + tot_trab_04 + tot_trab_05 + tot_trab_06 +
tot_trab_07 + tot_trab_08 + tot_trab_09 + tot_trab_10)) %>%
mutate(trabajadores = case_when(
month(fh_inicio_itt) == 3 ~ tot_trab_03,
month(fh_inicio_itt) == 4 ~ tot_trab_04,
month(fh_inicio_itt) == 5 ~ tot_trab_05,
month(fh_inicio_itt) == 6 ~ tot_trab_06,
month(fh_inicio_itt) == 7 ~ tot_trab_07,
month(fh_inicio_itt) == 8 ~ tot_trab_08,
month(fh_inicio_itt) == 9 ~ tot_trab_09,
month(fh_inicio_itt) == 10 ~ tot_trab_10,
TRUE ~ mean_trabajadores
)) %>%
group_by(cve_reg_patronal, semana_epidemiologica, trabajadores,
descripcion_division, delegacion_ads, nombre_empresa) %>%
tally() %>%
mutate(probabilidad_empresa = n/trabajadores) %>% ungroup()
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta")
dats <- dats %>%
filter(descripcion_division != "") %>%
mutate(fh_inicio_itt = dmy(fh_inicio_itt)) %>%
mutate(semana_epidemiologica = epiweek(fh_inicio_itt)) %>%
group_by(cve_reg_patronal, semana_epidemiologica, trabajadores,
descripcion_division, delegacion_ads, nombre_empresa) %>%
tally() %>% ungroup() %>%
mutate(mean_trabajadores = 1/8*(tot_trab_03 + tot_trab_04 + tot_trab_05 + tot_trab_06 +
tot_trab_07 + tot_trab_08 + tot_trab_09 + tot_trab_10)) %>%
mutate(trabajadores = case_when(
month(fh_inicio_itt) == 3 ~ tot_trab_03,
month(fh_inicio_itt) == 4 ~ tot_trab_04,
month(fh_inicio_itt) == 5 ~ tot_trab_05,
month(fh_inicio_itt) == 6 ~ tot_trab_06,
month(fh_inicio_itt) == 7 ~ tot_trab_07,
month(fh_inicio_itt) == 8 ~ tot_trab_08,
month(fh_inicio_itt) == 9 ~ tot_trab_09,
month(fh_inicio_itt) == 10 ~ tot_trab_10,
TRUE ~ mean_trabajadores
)) %>%
mutate(probabilidad_empresa = n/trabajadores)
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta")
dats <- dats %>%
filter(descripcion_division != "") %>%
mutate(fh_inicio_itt = dmy(fh_inicio_itt)) %>%
mutate(semana_epidemiologica = epiweek(fh_inicio_itt)) %>%
mutate(mean_trabajadores = 1/8*(tot_trab_03 + tot_trab_04 + tot_trab_05 + tot_trab_06 +
tot_trab_07 + tot_trab_08 + tot_trab_09 + tot_trab_10)) %>%
mutate(trabajadores = case_when(
month(fh_inicio_itt) == 3 ~ tot_trab_03,
month(fh_inicio_itt) == 4 ~ tot_trab_04,
month(fh_inicio_itt) == 5 ~ tot_trab_05,
month(fh_inicio_itt) == 6 ~ tot_trab_06,
month(fh_inicio_itt) == 7 ~ tot_trab_07,
month(fh_inicio_itt) == 8 ~ tot_trab_08,
month(fh_inicio_itt) == 9 ~ tot_trab_09,
month(fh_inicio_itt) == 10 ~ tot_trab_10,
TRUE ~ mean_trabajadores
)) %>%
group_by(cve_reg_patronal, semana_epidemiologica, trabajadores,
descripcion_division, delegacion_ads, nombre_empresa) %>%
tally() %>%
mutate(probabilidad_empresa = n/trabajadores) %>% ungroup()
rubro <- dats %>%
group_by(semana_epidemiologica, delegacion_ads, descripcion_division, n, trabajadores) %>%
summarise(n_total = sum(n), n_trabajadores = sum(trabajadores))
rubro
rubro <- rubro %>%
mutate(probabilidad_rubro = n_total/n_trabajadores)
rubro
View(rubro)
dats <- dats %>%
left_join(rubro)
rm(list = ls())
library(tidyverse)
library(haven)
library(lubridate)
setwd("/Users/rod/Dropbox/Coronavirus/walmart")
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta")
dats <- dats %>%
filter(descripcion_division != "") %>%
mutate(fh_inicio_itt = dmy(fh_inicio_itt)) %>%
mutate(semana_epidemiologica = epiweek(fh_inicio_itt)) %>%
mutate(mean_trabajadores = 1/8*(tot_trab_03 + tot_trab_04 + tot_trab_05 + tot_trab_06 +
tot_trab_07 + tot_trab_08 + tot_trab_09 + tot_trab_10)) %>%
mutate(trabajadores = case_when(
month(fh_inicio_itt) == 3 ~ tot_trab_03,
month(fh_inicio_itt) == 4 ~ tot_trab_04,
month(fh_inicio_itt) == 5 ~ tot_trab_05,
month(fh_inicio_itt) == 6 ~ tot_trab_06,
month(fh_inicio_itt) == 7 ~ tot_trab_07,
month(fh_inicio_itt) == 8 ~ tot_trab_08,
month(fh_inicio_itt) == 9 ~ tot_trab_09,
month(fh_inicio_itt) == 10 ~ tot_trab_10,
TRUE ~ mean_trabajadores
)) %>%
group_by(cve_reg_patronal, semana_epidemiologica, trabajadores,
descripcion_division, delegacion_ads, nombre_empresa) %>%
tally() %>%
mutate(probabilidad_empresa = n/trabajadores) %>% ungroup()
rubro <- dats %>%
group_by(semana_epidemiologica, delegacion_ads, descripcion_division, n, trabajadores) %>%
summarise(n_total = sum(n), n_trabajadores = sum(trabajadores)) %>%
mutate(probabilidad_rubro = n_total/n_trabajadores) %>%
select(-n, -trabajadores)
dats <- dats %>%
left_join(rubro, by = c("semana_epidemiologica", "descripcion_division", "delegacion_ads"))
View(dats)
View(dats)
rubro <- dats %>%
group_by(semana_epidemiologica, descripcion_division, n, trabajadores) %>%
summarise(n_total = sum(n), n_trabajadores = sum(trabajadores)) %>%
mutate(probabilidad_rubro = n_total/n_trabajadores) %>%
select(-n, -trabajadores)
2
rm(list = ls())
library(tidyverse)
library(haven)
library(lubridate)
setwd("/Users/rod/Dropbox/Coronavirus/walmart")
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta")
dats <- dats %>%
filter(descripcion_division != "") %>%
mutate(fh_inicio_itt = dmy(fh_inicio_itt)) %>%
mutate(semana_epidemiologica = epiweek(fh_inicio_itt)) %>%
mutate(mean_trabajadores = 1/8*(tot_trab_03 + tot_trab_04 + tot_trab_05 + tot_trab_06 +
tot_trab_07 + tot_trab_08 + tot_trab_09 + tot_trab_10)) %>%
mutate(trabajadores = case_when(
month(fh_inicio_itt) == 3 ~ tot_trab_03,
month(fh_inicio_itt) == 4 ~ tot_trab_04,
month(fh_inicio_itt) == 5 ~ tot_trab_05,
month(fh_inicio_itt) == 6 ~ tot_trab_06,
month(fh_inicio_itt) == 7 ~ tot_trab_07,
month(fh_inicio_itt) == 8 ~ tot_trab_08,
month(fh_inicio_itt) == 9 ~ tot_trab_09,
month(fh_inicio_itt) == 10 ~ tot_trab_10,
TRUE ~ mean_trabajadores
)) %>%
group_by(cve_reg_patronal, semana_epidemiologica, trabajadores,
descripcion_division, delegacion_ads, nombre_empresa) %>%
tally() %>%
mutate(probabilidad_empresa = n/trabajadores) %>% ungroup()
rubro <- dats %>%
group_by(semana_epidemiologica, delegacion_ads, descripcion_division, n, trabajadores) %>%
summarise(n_total = sum(n), n_trabajadores = sum(trabajadores)) %>%
mutate(probabilidad_rubro = n_total/n_trabajadores) %>%
select(-n, -trabajadores)
View(rubro)
View(dats)
rubro <- rubro %>% ungroup()
rubro <- rubro %>% ungroup() %>% select(-n)
rubro <- dats %>%
group_by(semana_epidemiologica, delegacion_ads, descripcion_division, n, trabajadores) %>%
summarise(n_total = sum(n), n_trabajadores = sum(trabajadores)) %>%
ungroup() %>%
mutate(probabilidad_rubro = n_total/n_trabajadores) %>%
select(-n, -trabajadores)
View(rubro)
rubro <- dats %>%
group_by(semana_epidemiologica, delegacion_ads, descripcion_division) %>%
summarise(n_total = sum(n), n_trabajadores = sum(trabajadores)) %>%
ungroup() %>%
mutate(probabilidad_rubro = n_total/n_trabajadores) %>%
select(-n, -trabajadores)
rubro <- dats %>%
group_by(semana_epidemiologica, delegacion_ads, descripcion_division) %>%
summarise(n_total = sum(n), n_trabajadores = sum(trabajadores))
rubro <- dats %>%
group_by(semana_epidemiologica, delegacion_ads, descripcion_division) %>%
summarise(n_total = sum(n), n_trabajadores = sum(trabajadores)) %>%
ungroup() %>%
mutate(probabilidad_rubro = n_total/n_trabajadores) %>%
select(-n, -trabajadores)
rubro <- dats %>%
group_by(semana_epidemiologica, delegacion_ads, descripcion_division) %>%
summarise(n_total = sum(n), n_trabajadores = sum(trabajadores)) %>%
ungroup() %>%
mutate(probabilidad_rubro = n_total/n_trabajadores)
View(rubro)
dats <- dats %>%
left_join(rubro, by = c("semana_epidemiologica", "descripcion_division", "delegacion_ads"))
View(dats)
View(dats)
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta")
View(dats)
rm(list = ls())
library(tidyverse)
library(haven)
library(lubridate)
setwd("/Users/rod/Dropbox/Coronavirus/walmart")
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta")
dats <- dats %>%
filter(descripcion_division != "") %>%
mutate(fh_inicio_itt = dmy(fh_inicio_itt)) %>%
mutate(semana_epidemiologica = epiweek(fh_inicio_itt)) %>%
mutate(mean_trabajadores = 1/8*(tot_trab_03 + tot_trab_04 + tot_trab_05 + tot_trab_06 +
tot_trab_07 + tot_trab_08 + tot_trab_09 + tot_trab_10)) %>%
mutate(trabajadores = case_when(
month(fh_inicio_itt) == 3 ~ tot_trab_03,
month(fh_inicio_itt) == 4 ~ tot_trab_04,
month(fh_inicio_itt) == 5 ~ tot_trab_05,
month(fh_inicio_itt) == 6 ~ tot_trab_06,
month(fh_inicio_itt) == 7 ~ tot_trab_07,
month(fh_inicio_itt) == 8 ~ tot_trab_08,
month(fh_inicio_itt) == 9 ~ tot_trab_09,
month(fh_inicio_itt) == 10 ~ tot_trab_10,
TRUE ~ mean_trabajadores
)) %>%
group_by(cve_reg_patronal, semana_epidemiologica, trabajadores,
descripcion_division, desc_entidad, nombre_empresa) %>%
tally() %>%
mutate(probabilidad_empresa = n/trabajadores) %>% ungroup()
rubro <- dats %>%
group_by(semana_epidemiologica, desc_entidad, descripcion_division) %>%
summarise(n_total = sum(n), n_trabajadores = sum(trabajadores)) %>%
ungroup() %>%
mutate(probabilidad_rubro = n_total/n_trabajadores)
dats <- dats %>%
left_join(rubro, by = c("semana_epidemiologica", "descripcion_division", "desc_entidad"))
View(dats)
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta")
View(dats)
rm(list = ls())
library(tidyverse)
library(haven)
library(lubridate)
setwd("/Users/rod/Dropbox/Coronavirus/walmart")
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta")
dats <- dats %>%
filter(descripcion_division != "") %>%
mutate(fh_inicio_itt = dmy(fh_inicio_itt)) %>%
mutate(semana_epidemiologica = epiweek(fh_inicio_itt)) %>%
mutate(mean_trabajadores = 1/8*(tot_trab_03 + tot_trab_04 + tot_trab_05 + tot_trab_06 +
tot_trab_07 + tot_trab_08 + tot_trab_09 + tot_trab_10)) %>%
mutate(trabajadores = case_when(
month(fh_inicio_itt) == 3 ~ tot_trab_03,
month(fh_inicio_itt) == 4 ~ tot_trab_04,
month(fh_inicio_itt) == 5 ~ tot_trab_05,
month(fh_inicio_itt) == 6 ~ tot_trab_06,
month(fh_inicio_itt) == 7 ~ tot_trab_07,
month(fh_inicio_itt) == 8 ~ tot_trab_08,
month(fh_inicio_itt) == 9 ~ tot_trab_09,
month(fh_inicio_itt) == 10 ~ tot_trab_10,
TRUE ~ mean_trabajadores
)) %>%
group_by(cve_reg_patronal, semana_epidemiologica, trabajadores,
descripcion_division, delegacion_ads, nombre_empresa) %>%
tally() %>%
mutate(probabilidad_empresa = n/trabajadores) %>% ungroup()
rubro <- dats %>%
group_by(semana_epidemiologica, delegacion_ads, descripcion_division) %>%
summarise(n_total = sum(n), n_trabajadores = sum(trabajadores)) %>%
ungroup() %>%
mutate(probabilidad_rubro = n_total/n_trabajadores)
dats <- dats %>%
left_join(rubro, by = c("semana_epidemiologica", "descripcion_division", "delegacion_ads"))
View(dats)
dats <- dats %>%
mutate(brote = probabilidad_empresa > 2*probabilidad_rubro)
sum(dats$brote)
sum(dats$brote, na.rm = T)
dats <- dats %>%
mutate(brote    = probabilidad_empresa > 2*probabilidad_rubro) %>%
mutate(brote_10 = probabilidad_empresa > 2*probabilidad_rubro & n > 10)
dats <- dats %>%
mutate(brote    = probabilidad_empresa > 2*probabilidad_rubro) %>%
mutate(brote_10 = probabilidad_empresa > 2*probabilidad_rubro & n > 10)
dats %>% filter(brote) %>% tally()
dats %>% filter(brote_10) %>% tally() %>% as.numeric()
dats %>% filter(brote) %>% tally() %>% as.numeric()
dats %>% filter(brote_10) %>% tally() %>% as.numeric()
dats <- dats %>%
mutate(brote    = probabilidad_empresa > 2*probabilidad_rubro) %>%
mutate(brote_10 = probabilidad_empresa > 2*probabilidad_rubro & n > 10) %>%
mutate(brote_10 = probabilidad_empresa > 2*probabilidad_rubro & n > 5)
dats %>% filter(brote) %>% tally() %>% as.numeric()
dats %>% filter(brote_10) %>% tally() %>% as.numeric()
dats %>% filter(brote_5) %>% tally() %>% as.numeric()
dats <- dats %>%
mutate(brote    = probabilidad_empresa > 2*probabilidad_rubro) %>%
mutate(brote_10 = probabilidad_empresa > 2*probabilidad_rubro & n > 10) %>%
mutate(brote_5 = probabilidad_empresa > 2*probabilidad_rubro & n > 5)
dats %>% filter(brote) %>% tally() %>% as.numeric()
dats %>% filter(brote_10) %>% tally() %>% as.numeric()
dats %>% filter(brote_5) %>% tally() %>% as.numeric()
trabajadores <- c(dats %>% filter(brote) %>% tally() %>% as.numeric(),
dats %>% filter(brote_10) %>% tally() %>% as.numeric(),
dats %>% filter(brote_5) %>% tally() %>% as.numeric())
dats %>% filter(brote) %>% select(cve_reg_patronal) %>% distinct() %>% tally() %>% as.numeric()
trabajadores <- c(dats %>% filter(brote) %>% tally() %>% as.numeric(),
dats %>% filter(brote_10) %>% tally() %>% as.numeric(),
dats %>% filter(brote_5) %>% tally() %>% as.numeric())
empresas <- c(
dats %>% filter(brote) %>% select(cve_reg_patronal) %>% distinct() %>% tally() %>% as.numeric(),
dats %>% filter(brote_10) %>% select(cve_reg_patronal) %>% distinct() %>% tally() %>% as.numeric(),
dats %>% filter(brote_5) %>% select(cve_reg_patronal) %>% distinct() %>% tally() %>% as.numeric())
trabajadores
empresas
data.frame(
trabajadores,
empresas,
metodo = c("RR > 2", "RR > 2 y Casos semanales > 10", "RR > 2 y Casos semanales > 5")
) %>%
write_csv("AnalisisBrote.csv")
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta")
rm(list = ls())
library(tidyverse)
library(haven)
library(lubridate)
setwd("/Users/rod/Dropbox/Coronavirus/walmart")
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta")
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta")
rm(list = ls())
library(tidyverse)
library(haven)
library(lubridate)
setwd("/Users/rod/Dropbox/Coronavirus/walmart")
dats <- read_dta("bd_tot_cveregpatronal_26oct_rzt.dta")
dats <- dats %>%
filter(descripcion_division != "") %>%
mutate(fh_inicio_itt = dmy(fh_inicio_itt)) %>%
mutate(semana_epidemiologica = epiweek(fh_inicio_itt)) %>%
mutate(mean_trabajadores = 1/8*(tot_trab_03 + tot_trab_04 + tot_trab_05 + tot_trab_06 +
tot_trab_07 + tot_trab_08 + tot_trab_09 + tot_trab_10)) %>%
mutate(trabajadores = case_when(
month(fh_inicio_itt) == 3 ~ tot_trab_03,
month(fh_inicio_itt) == 4 ~ tot_trab_04,
month(fh_inicio_itt) == 5 ~ tot_trab_05,
month(fh_inicio_itt) == 6 ~ tot_trab_06,
month(fh_inicio_itt) == 7 ~ tot_trab_07,
month(fh_inicio_itt) == 8 ~ tot_trab_08,
month(fh_inicio_itt) == 9 ~ tot_trab_09,
month(fh_inicio_itt) == 10 ~ tot_trab_10,
TRUE ~ mean_trabajadores
)) %>%
group_by(cve_reg_patronal, semana_epidemiologica, trabajadores,
descripcion_division, delegacion_ads, nombre_empresa) %>%
tally() %>%
mutate(probabilidad_empresa = n/trabajadores) %>% ungroup()
rubro <- dats %>%
group_by(semana_epidemiologica, delegacion_ads, descripcion_division) %>%
summarise(n_total = sum(n), n_trabajadores = sum(trabajadores)) %>%
ungroup()
dats <- dats %>%
left_join(rubro, by = c("semana_epidemiologica", "descripcion_division", "delegacion_ads"))
dats <- dats %>%
#Calculamos la probabilidad eliminando la empresa
mutate(probabilidad_rubro = (n_total - n)/(n_trabajadores - trabajadores)) %>%
mutate(brote    = probabilidad_empresa > 2*probabilidad_rubro) %>%
mutate(brote_10 = probabilidad_empresa > 2*probabilidad_rubro & n > 10) %>%
mutate(brote_5 = probabilidad_empresa > 2*probabilidad_rubro & n > 5)
trabajadores <- c(dats %>% filter(brote) %>% tally() %>% as.numeric(),
dats %>% filter(brote_10) %>% tally() %>% as.numeric(),
dats %>% filter(brote_5) %>% tally() %>% as.numeric())
empresas <- c(
dats %>% filter(brote) %>% select(cve_reg_patronal) %>% distinct() %>% tally() %>% as.numeric(),
dats %>% filter(brote_10) %>% select(cve_reg_patronal) %>% distinct() %>% tally() %>% as.numeric(),
dats %>% filter(brote_5) %>% select(cve_reg_patronal) %>% distinct() %>% tally() %>% as.numeric())
data.frame(
trabajadores,
empresas,
metodo = c("RR > 2", "RR > 2 y Casos semanales > 10", "RR > 2 y Casos semanales > 5")
) %>%
write_csv("AnalisisBrote_v2.csv")
